repositories:
- name: bitnami
  url: registry-1.docker.io/bitnamicharts
  oci: true

releases:
  - name: postgres
    namespace: grist
    chart: bitnami/postgresql
    version: 13.1.5
    values:
      - auth:
          username: grist
          password: grist
          database: grist
      - tls:
          enabled: true
          autoGenerated: true
  - name: redis
    namespace: grist
    chart: bitnami/redis
    version: 18.1.5
    values:
    - architecture: standalone
    - auth:
        enabled: true
        password: grist
    - master:
        disableCommands: []
  - name: minio
    namespace: grist
    chart: bitnami/minio
    version: 12.10.10
    values: 
      - mode: distributed
      - auth:
          rootUser: gristgristgrist
          rootPassword: gristgristgrist
      - provisioning:
          enabled: true
          buckets:
            - name: grist
              versioning: true
  - name: grist
    namespace: grist
    chart: ../../helm_chart
    values:
      - values.grist.yaml
  - name: keycloak
    namespace: grist
    chart: bitnami/keycloak
    version: 17.3.6
    values:
      - postgresql:
          auth:
            username: keycloak
            password: keycloak
            databaese: keycloak
      - extraEnvVars:
          - name: KEYCLOAK_EXTRA_ARGS
            value: "--import-realm"
          - name: KC_HOSTNAME_URL
            value: https://keycloak.minikube.local
      - extraVolumes:
          - name: import
            configMap:
              name: grist
      - extraVolumeMounts:
          - name: import
            mountPath: /opt/bitnami/keycloak/data/import/
      - auth:
          adminUser: su
          adminPassword: su
      - proxy: edge
      - ingress:
          enabled: true
          hostname: keycloak.minikube.local
      - extraDeploy:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grist
          data:
            grist.json: |
{{ readFile "../docker_compose/grist.json" | replace "http://grist.docker.localhost:8080"  "https://grist.minikube.local"| indent 14 }}
